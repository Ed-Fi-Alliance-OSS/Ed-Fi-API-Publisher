# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

version: "3.8"

services:
  apipublisher:
    build:
      context: ../
      dockerfile: Dockerfile
    environment:
      VERSION: "${VERSION}"
      BEARER_TOKEN_REFRESH_MINUTES: ${BEARER_TOKEN_REFRESH_MINUTES}
      RETRY_STARTING_DELAY_MILLISECONDS: ${RETRY_STARTING_DELAY_MILLISECONDS}
      MAX_RETRY_ATTEMPTS: ${MAX_RETRY_ATTEMPTS}
      MAX_DEGREE_OF_PARALLELISM_FOR_RESOURCE_PROCESSING: ${MAX_DEGREE_OF_PARALLELISM_FOR_RESOURCE_PROCESSING}
      MAX_DEGREE_OF_PARALLELISM_FOR_POST_RESOURCE_ITEM: ${MAX_DEGREE_OF_PARALLELISM_FOR_POST_RESOURCE_ITEM}
      MAX_DEGREE_OF_PARALLELISM_FOR_STREAM_RESOURCE_PAGES: ${MAX_DEGREE_OF_PARALLELISM_FOR_STREAM_RESOURCE_PAGES}
      STREAMING_PAGES_WAIT_DURATION_SECONDS: ${STREAMING_PAGES_WAIT_DURATION_SECONDS}
      STREAMING_PAGE_SIZE: ${STREAMING_PAGE_SIZE}
      INCLUDE_DESCRIPTORS: ${INCLUDE_DESCRIPTORS}
      ERROR_PUBLISHING_BATCH_SIZE: ${ERROR_PUBLISHING_BATCH_SIZE}
      USE_CHANGE_VERSION_PAGING: ${USE_CHANGE_VERSION_PAGING}
      CHANGE_VERSION_PAGING_WINDOW_SIZE: ${CHANGE_VERSION_PAGING_WINDOW_SIZE}
      PROVIDER: ${PROVIDER}
      SQLSERVER_SERVER: ${SQLSERVER_SERVER}
      SQLSERVER_DATABASE: ${SQLSERVER_DATABASE}
      POSTGRESQL_HOST: ${POSTGRESQL_HOST}
      POSTGRESQL_DATABASE: ${POSTGRESQL_DATABASE}
      AWS_PROFILE: ${AWS_PROFILE}
      AWS_REGION: ${AWS_REGION}
      WRITE_TO_FILE_PATH: ${WRITE_TO_FILE_PATH}
      SOURCE_NAME: ${SOURCE_NAME}
      SOURCE_URL: ${SOURCE_URL}
      SOURCE_KEY: ${SOURCE_KEY}
      SOURCE_SECRET: ${SOURCE_SECRET}
      TARGET_NAME: ${TARGET_NAME}
      TARGET_URL: ${TARGET_URL}
      TARGET_KEY: ${TARGET_KEY}
      TARGET_SECRET: ${TARGET_SECRET}
    volumes:
      - apipublisher-logs:/tmp/logs
    restart: always
    hostname: apipublisher
    container_name: ed-fi-ods-apipublisher

volumes:
  apipublisher-logs:
    driver: local
    name: vol-apipublisher-logs