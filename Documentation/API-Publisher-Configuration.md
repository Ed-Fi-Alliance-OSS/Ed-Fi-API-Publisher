# Ed-Fi API Publisher Configuration

The Ed-Fi API Publisher provides a hierarchical organization of configuration information, as documented below.

The first layer of configuration values are provided by the _publisherSettings.json_ file, which should reside in the same folder as the Ed-Fi API Publisher's binaries. This file contains the general Options available for altering the runtime behavior.
The Options values can also be supplied (overridden) using environment variables or command-line arguments, as needed.

Command-line arguments take precedence over environment variables, which in turn take precedence over the values defined in the _publisherSettings.json_ configuration file. To use environment variables to provide configuration values, use the "Configuration Path" from the tables below, and add an `EdFi:Publisher:` prefix to the name of each variable. For example, to specify a named connection for the source API using an environment variable, use an environment variable name of `EdFi:Publisher:Connections:Source:Name`.

## Options

Defines general behavior of the Ed-Fi API Publisher.

| Configuration Path / Command-Line Argument                                                                | Description                                                                                                                                                                                                                                                                                |
| --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Options:BearerTokenRefreshMinutes<br/>`--bearerTokenRefreshMinutes`                                       | Indicates how frequently the Ed-Fi API Publisher will obtain a new bearer token from the source and target API endpoints.<br/>(_Default value: 12_)                                                                                                                                        |
| Options:PostRetryStartingDelayMilliseconds<br/>`--retryStartingDelayMilliseconds`                         | Indicates the initial delay in milliseconds used when performing an exponential "back off" delay for retries.<br/>(_Default value: 200_)                                                                                                                                                   |
| Options:MaxPostRetryAttempts<br/>`--maxRetryAttempts`                                                     | Indicates the total number of times the Ed-Fi API Publisher will attempt to POST a request against the target API before determining that the failure is permanent.<br/>(_Default value: 5_)                                                                                               |
| Options:MaxDegreeOfParallelismForPostResourceItem<br/>`--maxDegreeOfParallelismForPostResourceItem`       | Indicates the total number of parallel threads that could be simultaneously issuing POST requests against the target API.<br/>(_Default value: 50_)                                                                                                                                        |
| Options:MaxDegreeOfParallelismForStreamResourcePages<br/>`--maxDegreeOfParallelismForStreamResourcePages` | Indicates the total number of resources that could be processed simultaneously, assuming all dependencies have been satisfied.<br/>(_Default value: 5_)                                                                                                                                    |
| Options:StreamingPagesWaitDurationSeconds<br/>`--streamingPagesWaitDurationSeconds`                       | Indicates the number of seconds to wait for the streaming of any of the currently streaming resources to complete before providing an update on progress using the logger.<br/>(_Default value: 10_)                                                                                       |
| Options:StreamingPageSize<br/>`--streamingPageSize`                                                       | Indicates the number of items to include in each page when streaming resources from the source API.<br/>(_Default value: 75_)                                                                                                                                                              |
| Options:IncludeDescriptors<br/>`--includeDescriptors`                                                     | Indicates whether or not to attempt to publish descriptors.<br/>(_Default value: false_)                                                                                                                                                                                                   |
| Options:ErrorPublishingBatchSize<br/>`--errorPublishingBatchSize`                                         | Indicates the number of items to batch in each call to the error writer. This could be used to optimize the size of a batch write depending on the operating environment (e.g. Amazon DynamoDB allows for 25 items to be written in a BatchWriteItem operation).<br/>(_Default value: 25_) |

## API Connections

Generally, just the pre-configured names for the source and target API connections should be provided to the Ed-Fi API Publisher (e.g. `--sourceName=abcd --targetName=wxyz`). However, if it is necessary to supply the connection information explicitly, the values can be provided using environment variables or command-line arguments (as documented below).

> NOTE: If the Ed-Fi API Publisher is executed using explicit connection information (rather than a pre-configured _named_ connection), the LastChangeVersionProcessed value cannot be updated automatically upon successful publishing (as there is no API connection name associated with the information). It will be the responsibility of the caller to update the value appropriately after extracting the new change version from the log output (or through some other enterprising manner). As such, for implementing a process that is intended to only publish _changes_ from a source to a target, it is impractical to use an approach where the API connection details are provided explicitly at execution time.

To select or supply source and target connection information, the following configuration values apply:

| Configuration Path                                                                 | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ---------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Connections:Source:Name<br/>`--sourceName`                                         | The name of the preconfigured connection for the source Ed-Fi ODS API.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Connections:Source:Url<br/>`--sourceUrl`                                           | The URL of the source Ed-Fi ODS API. _Only required if named connections are not in use._                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Connections:Source:Key<br/>`--sourceKey`                                           | The API key for authenticating with the source Ed-Fi ODS API. _Only required if named connections are not in use._                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Connections:Source:Secret<br/>`--sourceSecret`                                     | The API secret for authenticating with the source Ed-Fi ODS API. _Only required if named connections are not in use._                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| Connections:Source:Scope<br/>`--sourceScope`                                       | (_Optional_) The EducationOrganizationId scope requested for the resulting access token. The value must be an EducationOrganizationId that is explicitly associated with the API client by the source Ed-Fi ODS API.<br/><br/>Intended for use to allow a single API connection configuration to be used to read changes from the controlling organization's Ed-Fi ODS API, but with the operations of the Ed-Fi API Publisher authorized for a particular Education Organization.                                                                                                                                                                                                                                  |
| Connection:Source:Resources<br/>`--resources`                                      | (_Optional_) For _source_ API connections, the resources to publish to the target. The value is defined using a CSV format (comma-separated values), and should contain the partial paths to the resources (e.g. _/ed-fi/students_,_/custom/busRoutes_). For convenience when working with Ed-Fi standard resources, only the name is required (e.g. _students,studentSchoolAssociations_). The Ed-Fi API Publisher will also evaluate and automatically include all dependencies of the requested resources (using the dependency metadata exposed by the target API). This will ensure (barring misconfigured authorization metadata or data policies) that data can be successfully published to the target API. |
| Connection:Source:ExcludeResources<br/>`--excludeResources`                        | (_Optional_) For _source_ API connections, the resources to NOT publish to the target. The value is defined using the same format as with `--resources` (see above). The Ed-Fi API Publisher will also evaluate and automatically exclude all dependent resources of the excluded resources (using the dependency metadata exposed by the target API). This will ensure (barring misconfigured authorization metadata or data policies) that data can be successfully published to the target API. This argument is mutually exclusive with the `--resources` argument, which take precedence if both are provided.                                                                                                 |
| Connections:Source:IgnoreIsolation<br/>`--ignoreIsolation`                         | (_Optional_) A boolean value (`true`/`false`) indicating whether the source Ed-Fi ODS API data should be published even if it does not support an isolated context through the use of database snapshots. (NOTE: This is not a flag -- the value `true` or `false` must be provided (i.e. `--ignoreIsolation=true`).)                                                                                                                                                                                                                                                                                                                                                                                               |
| Connections:Source:LastChangeVersionProcessed<br/>`--lastChangeVersionProcessed`   | _(Optional)_ Indicates the last change version successfully published from the _source_ API, and thus the change version _after_ which the current publishing operation should start. _This value explicitly overrides any change version value obtained from a named connection._                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Connections:Target:Name<br/>`--targetName`                                         | The name of the pre-configured connection for the target Ed-Fi ODS API.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| Connections:Target:Url<br/>`--targetUrl`                                           | The URL of the target Ed-Fi ODS API. _Only required if named connections are not in use._                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Connections:Target:Key<br/>`--targetKey`                                           | The API key for authenticating with the target Ed-Fi ODS API. _Only required if named connections are not in use._                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| Connections:Target:Secret<br/>`--targetSecret`                                     | The API secret for authenticating with the target Ed-Fi ODS API. _Only required if named connections are not in use._                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| Connections:Target:Scope<br/>`--targetScope`                                       | (_Optional_) The EducationOrganizationId scope requested for the resulting access token. The value must be an EducationOrganizationId that is explicitly associated with the API client by the target Ed-Fi ODS API.<br/><br/>Intended for use to allow a single API connection configuration to be used to publish changes to the controlling organization's Ed-Fi ODS API, but with the operations of the Ed-Fi API Publisher authorized for a particular Education Organization.                                                                                                                                                                                                                                 |
| Connections:Target:TreatForbiddenPostAsWarning<br/>`--treatForbiddenPostAsWarning` | _(Optional)_ A boolean value (true/false) indicating whether `403 Forbidden` responses from `POST` requests against the connection (as a target) should be treated as a warning, rather than a failure.<br/><br/>NOTE: This option can be used in scenarios where the target API may not grant the Ed-Fi API Publisher full CRUD permissions to all the dependencies of the specified resources to be written. In such a scenario, the dependent data must already exist in the target ODS or the resulting `409 Conflict` responses will cause publishing failure.                                                                                                                                                 |

## Authorization Failure Handling

Defines metadata (as an array of JSON objects) about which resources could experience `403 Forbidden` responses caused by data dependencies needed for successful authorization, and which other resources should be processed before retrying the original request. For example, while an API client may be able to create a Student, they won't be able to _update_ the Student until that Student is enrolled in a School through the StudentSchoolAssociation. By defining the authorization-related dependency of the _update_ operation on the StudentSchoolAssociation, the Ed-Fi API Publisher can know to retry the failed POST request after the association has been established.

NOTE: This part of the configuration can only be defined in the _publisherSettings.json_ file.

| JSON Path                                                  | Description                                                                                                                                                                                                  |
| ---------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| /authorizationFailureHandling\[\*]                         | Defines metadata for a single resource which could experience 403 Forbidden responses.                                                                                                                       |
| /authorizationFailureHandling\[\*]/path                    | The partial path for the resource (e.g. _/ed-fi/students_) for which additional 403 Forbidden processing should be performed.                                                                                |
| /authorizationFailureHandling\[\*]/updatePrerequisitePaths | An array of partial paths for the resource(s) (e.g. _/ed-fi/studentSchoolAssociations_) that should be processed before attempting to retry the original request which resulted in an authorization failure. |

The default configuration, which will probably suffice for all current Ed-Fi ODS API deployments, is as follows:
```json
{  
  "options":   
  {  
    ...
  },  
  "authorizationFailureHandling": [  
    {  
      "path": "/ed-fi/students",  
      "updatePrerequisitePaths": ["/ed-fi/studentSchoolAssociations"]  
    },  
    {  
      "path": "/ed-fi/staffs",  
      "updatePrerequisitePaths": [  
        "/ed-fi/staffEducationOrganizationEmploymentAssociations",  
        "/ed-fi/staffEducationOrganizationAssignmentAssociations"  
      ]  
    },  
    {  
      "path": "/ed-fi/parents",  
      "updatePrerequisitePaths": ["/ed-fi/studentParentAssociations"]  
    }
  ]
}
```
